<!doctype html>
<html lang="tr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AI Video Studio — App</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Formal White + Blue (Fintech-clean) theme -->
  <style>
    :root{
      --bg: #F7F9FC;        /* broken white */
      --surface: #FFFFFF;   /* pure white */
      --border: #E6EAF2;    /* soft border */
      --text: #0B1220;      /* deep navy text */
      --muted: #52607A;     /* muted text */
      --blue: #2F6BFF;      /* primary */
      --blue2:#2458D6;      /* hover */
      --blueSoft: rgba(47,107,255,.10);
      --shadow: 0 10px 30px rgba(17, 24, 39, .06);
      --shadowBlue: 0 14px 40px rgba(47, 107, 255, .20);
    }

    body{ background: var(--bg); color: var(--text); }

    /* subtle formal hero glow (not dark) */
    .hero-bg{
      background:
              radial-gradient(900px 450px at 15% 10%, rgba(47,107,255,.14), transparent 60%),
              radial-gradient(800px 420px at 80% 18%, rgba(47,107,255,.08), transparent 62%),
              linear-gradient(180deg, #FFFFFF 0%, var(--bg) 55%, var(--bg) 100%);
    }

    .card{
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
    }
    .card-soft{
      background: #FFFFFF;
      border: 1px solid var(--border);
      border-radius: 16px;
    }

    .chip{
      border: 1px solid var(--border);
      background: #FFFFFF;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
    }
    .chip:hover{ background: #F3F6FF; border-color: #D6DEF0; }
    .chip:active{ transform: translateY(1px); }

    .btn-primary{
      background: var(--blue);
      color: #fff;
      box-shadow: var(--shadowBlue);
    }
    .btn-primary:hover{ background: var(--blue2); }
    .btn-ghost{
      background: #fff;
      border: 1px solid var(--border);
    }
    .btn-ghost:hover{ background: #F6F8FF; border-color: #D6DEF0; }
    .btn-soft{
      background: #F3F6FF;
      border: 1px solid #DDE6FF;
      color: var(--text);
    }
    .btn-soft:hover{ background: #EAF0FF; }

    .muted{ color: var(--muted); }

    /* chat */
    .bubble-ai{
      background: #FFFFFF;
      border: 1px solid var(--border);
      box-shadow: 0 6px 16px rgba(17, 24, 39, .05);
    }
    .bubble-user{
      background: rgba(47,107,255,.10);
      border: 1px solid rgba(47,107,255,.20);
    }

    /* nicer scrollbar for chat */
    .nice-scroll::-webkit-scrollbar{ width:10px; }
    .nice-scroll::-webkit-scrollbar-thumb{ background: rgba(82,96,122,.20); border-radius: 999px; border: 2px solid rgba(0,0,0,0); background-clip: padding-box; }
    .nice-scroll::-webkit-scrollbar-track{ background: rgba(0,0,0,0); }
  </style>
</head>

<body class="min-h-screen hero-bg">

<!-- Header -->
<header class="sticky top-0 z-40 border-b" style="border-color: var(--border); background: rgba(255,255,255,.80); backdrop-filter: blur(10px);">
  <div class="mx-auto flex max-w-7xl items-center justify-between px-4 py-3">
    <div class="flex items-center gap-3">
      <button id="openSidebar" class="md:hidden rounded-xl px-3 py-2 btn-ghost text-sm" aria-label="Open menu">☰</button>

      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-2xl flex items-center justify-center"
             style="background: var(--blue); color: #fff; box-shadow: var(--shadowBlue);">
          <span class="font-semibold">AV</span>
        </div>
        <div class="leading-tight">
          <div class="text-xs muted">AI Video Studio</div>
          <div class="text-sm font-semibold">Prompt Flow • Workflows • Publish</div>
        </div>
      </div>

      <span class="hidden md:inline-flex ml-2 rounded-full px-3 py-1 text-xs"
            style="background: #fff; border: 1px solid var(--border); color: var(--muted);">
        TikTok • Reels • Shorts
      </span>
    </div>

    <div class="flex items-center gap-2">
      <span id="creditsBadge"
            class="hidden md:inline-flex rounded-full px-3 py-1 text-xs"
            style="background:#fff; border:1px solid var(--border); color: var(--muted);">
        Credits: —
      </span>

      <a id="loginTopBtn" href="/login" class="rounded-xl px-4 py-2 text-sm btn-primary font-medium">
        Login
      </a>

      <a id="logoutTopBtn" href="/logout" class="hidden rounded-xl px-4 py-2 text-sm btn-ghost">
        Logout
      </a>

      <div id="avatar" class="hidden h-9 w-9 rounded-full items-center justify-center font-semibold"
           style="background:#fff; border:1px solid var(--border);">
        U
      </div>
    </div>
  </div>
</header>

<div class="mx-auto flex max-w-7xl">

  <!-- Sidebar -->
  <aside id="sidebar"
         class="fixed inset-y-0 left-0 z-50 w-72 -translate-x-full md:translate-x-0 md:static"
         style="background: rgba(255,255,255,.92); backdrop-filter: blur(10px); border-right: 1px solid var(--border);">
    <div class="flex h-full flex-col p-4">
      <div class="flex items-center justify-between md:hidden">
        <div class="text-sm font-semibold">Menü</div>
        <button id="closeSidebar" class="rounded-xl px-3 py-2 btn-ghost text-sm">Kapat</button>
      </div>

      <div id="guestBanner" class="mt-4 card-soft p-4">
        <div class="text-sm font-semibold">Guest Mode</div>
        <p class="mt-1 text-sm muted">Her şeyi gör. Üret / paylaş / hesap bağla için login.</p>
        <p id="guestDemoHint" class="mt-2 text-xs muted">Bonus: 1 demo render (filigranlı).</p>
        <a href="/login" class="mt-3 inline-flex text-sm" style="color: var(--blue);">Login →</a>
      </div>

      <div id="userBanner" class="mt-4 hidden card-soft p-4">
        <div class="text-sm muted">Hoş geldin</div>
        <div id="userName" class="mt-1 text-lg font-semibold">—</div>
        <div id="userPlan" class="mt-1 text-sm muted">Plan: —</div>
      </div>

      <nav class="mt-4 space-y-2">
        <button class="nav-btn w-full text-left px-4 py-3 rounded-xl btn-ghost" data-page="today">Today</button>
        <button class="nav-btn w-full text-left px-4 py-3 rounded-xl btn-ghost" data-page="create">Create</button>
        <button class="nav-btn w-full text-left px-4 py-3 rounded-xl btn-ghost" data-page="workflows">Workflows (Pro)</button>
        <button class="nav-btn w-full text-left px-4 py-3 rounded-xl btn-ghost" data-page="accounts">Accounts</button>
        <button class="nav-btn w-full text-left px-4 py-3 rounded-xl btn-ghost" data-page="library">Library</button>
        <button class="nav-btn w-full text-left px-4 py-3 rounded-xl btn-ghost" data-page="pricing">Pricing</button>
      </nav>

      <div class="mt-auto card-soft p-4">
        <div class="text-sm font-semibold">Hızlı Başlat</div>
        <p class="mt-1 text-sm muted">Trend seç → format seç → Create Flow</p>
        <button class="nav-btn mt-3 w-full rounded-xl px-4 py-3 text-sm btn-primary font-medium" data-page="today">
          Başla
        </button>
      </div>
    </div>
  </aside>

  <div id="overlay" class="fixed inset-0 z-40 hidden bg-black/40 md:hidden"></div>

  <!-- Main -->
  <main class="flex-1 p-4 md:p-6">

    <!-- TODAY -->
    <section class="page" id="page-today">
      <div class="flex flex-col gap-2 md:flex-row md:items-end md:justify-between">
        <div>
          <h1 class="text-3xl font-semibold">Bugün ne üretelim?</h1>
          <p class="mt-1 text-sm muted">Prompt yazmadan trendden seç. Ya da Create’te Prompt Flow ile adım adım ilerle.</p>
        </div>
        <button class="nav-btn rounded-xl px-4 py-3 text-sm btn-soft" data-page="create">Prompt Flow →</button>
      </div>

      <div class="mt-5 card p-4">
        <div class="flex items-center justify-between">
          <div class="text-sm font-semibold">3 adımda üret</div>
          <div class="text-xs muted">Minimal • Formal • Net</div>
        </div>
        <div class="mt-3 grid grid-cols-1 gap-3 md:grid-cols-3">
          <div class="card-soft p-3">
            <div class="text-xs muted">1) Trend</div>
            <div class="mt-1 font-medium">Başlığı seç</div>
          </div>
          <div class="card-soft p-3">
            <div class="text-xs muted">2) Format</div>
            <div class="mt-1 font-medium">Özet / Top3 / Story</div>
          </div>
          <div class="card-soft p-3">
            <div class="text-xs muted">3) Create</div>
            <div class="mt-1 font-medium">Flow açılır → Üret</div>
          </div>
        </div>
      </div>

      <div class="mt-6 grid grid-cols-1 gap-4 lg:grid-cols-3">
        <div class="lg:col-span-2 card p-4">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm font-semibold">Popüler Başlıklar (Mock)</div>
              <div class="text-sm muted">Karttan formatı seç → Create Flow’a düşer.</div>
            </div>
            <span class="hidden md:inline-flex rounded-full px-3 py-1 text-xs"
                  style="background: var(--blueSoft); color: var(--text); border: 1px solid rgba(47,107,255,.18);">
              AI-curated (demo)
            </span>
          </div>

          <div class="mt-4 grid grid-cols-1 gap-3 md:grid-cols-2" id="trendCards"></div>
        </div>

        <div class="card p-4">
          <div class="text-sm font-semibold">Seçim Özeti</div>
          <p class="mt-1 text-sm muted">Trend + format seçince Create’a taşı.</p>

          <div class="mt-4 card-soft p-4">
            <div class="text-xs muted">Seçilen trend</div>
            <div id="selectedTrend" class="mt-1 font-medium">—</div>
            <div id="selectedFormat" class="mt-2 text-sm muted">Format: —</div>

            <button id="useTrendBtn" class="mt-4 w-full rounded-xl px-4 py-3 text-sm btn-primary font-medium">
              Create Flow’a Git
            </button>
          </div>

          <div class="mt-4 card-soft p-4">
            <div class="text-sm font-semibold">Neden Prompt Flow?</div>
            <ul class="mt-2 text-sm muted space-y-1">
              <li>• Buton kalabalığı yok</li>
              <li>• Tıklayarak adım adım ilerlersin</li>
              <li>• En sonda tek “final prompt” oluşur</li>
            </ul>
          </div>
        </div>
      </div>
    </section>

    <!-- CREATE -->
    <section class="page hidden" id="page-create">
      <div class="flex flex-col gap-2 md:flex-row md:items-end md:justify-between">
        <div>
          <h1 class="text-3xl font-semibold">Create</h1>
          <p class="mt-1 text-sm muted">Seçimler prompt içine gömülür. Tıkladıkça ilerlersin (chat-like).</p>
        </div>

        <div class="flex gap-2">
          <button id="resetFlowBtn" class="rounded-xl px-4 py-3 text-sm btn-ghost">Flow’u sıfırla</button>
          <button id="generateBtn" class="rounded-xl px-4 py-3 text-sm btn-primary font-medium">Üret</button>
        </div>
      </div>

      <div class="mt-6 grid grid-cols-1 gap-4 lg:grid-cols-3">
        <div class="lg:col-span-2 card p-4">
          <div class="flex items-center justify-between gap-3">
            <div>
              <div class="text-sm font-semibold">Prompt Flow</div>
              <div class="text-sm muted">Seçimler chat içinde ilerler — butonlar burada görünür.</div>
            </div>
            <button id="flowWhyBtn" class="rounded-xl px-3 py-2 text-sm btn-ghost">Neden böyle?</button>
          </div>

          <div id="flowWhyTip" class="hidden mt-3 card-soft p-4 text-sm muted">
            Bu akış, kullanıcıya “panel doldurma” değil “rehberli seçim” hissi verir.
            Seçim sayısı artsa bile arayüz kalabalıklaşmaz.
          </div>

          <div id="flowChat" class="nice-scroll mt-4 h-[520px] overflow-y-auto rounded-2xl p-4"
               style="background:#fff; border:1px solid var(--border);">
          </div>

          <div class="mt-4 grid grid-cols-1 gap-3 md:grid-cols-3">
            <div class="md:col-span-2 card-soft p-3">
              <div class="text-xs muted">İstersen serbest prompt yaz</div>
              <textarea id="freePrompt"
                        class="mt-2 w-full rounded-xl p-3 text-sm outline-none"
                        style="background:#fff; border:1px solid var(--border);"
                        rows="3"
                        placeholder="Örn: ‘Bugünün teknoloji gündemini 30 saniyede anlat. Enerjik, kısa cümleler, sonunda soru.’"></textarea>
              <div class="mt-2 flex gap-2">
                <button id="applyFreePromptBtn" class="rounded-xl px-3 py-2 text-sm btn-primary font-medium">Prompt’u uygula</button>
                <button id="resumeFlowBtn" class="rounded-xl px-3 py-2 text-sm btn-ghost">Akışa devam</button>
              </div>
            </div>

            <div class="card-soft p-3">
              <div class="text-xs muted">Pro otomasyon</div>
              <div class="mt-2 text-sm font-semibold">Daily Workflow</div>
              <div class="mt-1 text-sm muted">Günde 1 video otomatik üret + Library’ye at.</div>
              <button class="needs-login mt-3 w-full rounded-xl px-3 py-3 text-sm btn-ghost">Pro ile aç</button>
            </div>
          </div>
        </div>

        <div class="space-y-4">
          <div class="card p-4">
            <div class="flex items-center justify-between">
              <div class="text-sm font-semibold">Final Prompt</div>
              <span class="text-xs rounded-full px-2 py-1"
                    style="background: var(--blueSoft); border:1px solid rgba(47,107,255,.18);">
                Backend’e gidecek
              </span>
            </div>
            <pre id="finalPromptBox"
                 class="mt-3 whitespace-pre-wrap rounded-2xl p-4 text-sm"
                 style="background:#fff; border:1px solid var(--border);">—</pre>
          </div>

          <div class="card p-4">
            <div class="flex items-center justify-between">
              <div class="text-sm font-semibold">Preview</div>
              <span class="text-xs rounded-full px-2 py-1"
                    style="background:#F1F4FB; border:1px solid var(--border); color: var(--muted);">
                Mock
              </span>
            </div>

            <div class="mt-4 aspect-[9/16] w-full rounded-2xl relative overflow-hidden"
                 style="background:#F1F4FB; border:1px solid var(--border);">
              <div class="absolute inset-0"
                   style="background: radial-gradient(circle at 30% 20%, rgba(47,107,255,.16), transparent 55%),
                              radial-gradient(circle at 80% 60%, rgba(47,107,255,.08), transparent 55%);">
              </div>
              <div class="absolute inset-0 flex items-center justify-center">
                <div class="text-center">
                  <div class="text-sm muted">Video preview burada</div>
                  <div class="mt-1 text-xs muted">Render sonrası thumbnail</div>
                </div>
              </div>
              <div id="watermarkBadge"
                   class="hidden absolute right-3 top-3 rounded-full px-3 py-1 text-xs"
                   style="background: rgba(0,0,0,.05); border: 1px dashed rgba(0,0,0,.20);">
                WATERMARK
              </div>
            </div>

            <div class="mt-4 grid grid-cols-2 gap-2">
              <button class="needs-login rounded-xl px-3 py-3 text-sm btn-ghost">İndir</button>
              <button class="needs-login rounded-xl px-3 py-3 text-sm btn-primary font-medium">Paylaş</button>
            </div>
          </div>

          <div class="card p-4">
            <div class="text-sm font-semibold">Render Durumu</div>
            <div class="mt-3">
              <div class="flex justify-between text-xs muted">
                <span id="renderState">IDLE</span><span id="renderPct">0%</span>
              </div>
              <div class="mt-2 h-2 w-full rounded-full" style="background:#E9EEF9;">
                <div id="renderBar" class="h-2 w-[0%] rounded-full" style="background: var(--blue);"></div>
              </div>
              <div id="renderNote" class="mt-3 text-xs muted">Demo progress.</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- WORKFLOWS -->
    <section class="page hidden" id="page-workflows">
      <div class="flex flex-col gap-2 md:flex-row md:items-end md:justify-between">
        <div>
          <h1 class="text-3xl font-semibold">Workflows</h1>
          <p class="mt-1 text-sm muted">Pro kullanıcılar için otomasyon: bir kere kur → düzenli üret.</p>
        </div>
        <button class="needs-login rounded-xl px-4 py-3 text-sm btn-primary font-medium">Pro’ya geç</button>
      </div>

      <div class="mt-6 grid grid-cols-1 gap-4 lg:grid-cols-3">
        <div class="lg:col-span-2 card p-4">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm font-semibold">Preset Workflows (Mock)</div>
              <div class="text-sm muted">Use → Create Flow’u otomatik doldurur.</div>
            </div>
            <span class="hidden md:inline-flex rounded-full px-3 py-1 text-xs"
                  style="background: var(--blueSoft); border:1px solid rgba(47,107,255,.18);">
              Creator-friendly
            </span>
          </div>
          <div class="mt-4 grid grid-cols-1 gap-3 md:grid-cols-2" id="workflowCards"></div>
        </div>

        <div class="card p-4">
          <div class="text-sm font-semibold">Pro Otomasyon Paketleri</div>
          <p class="mt-1 text-sm muted">Sende satacağın asıl kısım: süreklilik motoru.</p>

          <div class="mt-4 space-y-3">
            <div class="card-soft p-4">
              <div class="font-semibold">Daily Auto-Create</div>
              <div class="text-sm muted mt-1">Trend → Flow → günde 1 video</div>
              <button class="needs-login mt-3 w-full rounded-xl px-3 py-3 text-sm btn-ghost">Etkinleştir</button>
            </div>
            <div class="card-soft p-4">
              <div class="font-semibold">Series Builder</div>
              <div class="text-sm muted mt-1">7/14 gün seri içerik</div>
              <button class="needs-login mt-3 w-full rounded-xl px-3 py-3 text-sm btn-ghost">Etkinleştir</button>
            </div>
            <div class="card-soft p-4">
              <div class="font-semibold">A/B Hook Optimizer</div>
              <div class="text-sm muted mt-1">3 hook → en iyisini seç</div>
              <button class="needs-login mt-3 w-full rounded-xl px-3 py-3 text-sm btn-ghost">Etkinleştir</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ACCOUNTS -->
    <section class="page hidden" id="page-accounts">
      <div class="flex flex-col gap-2 md:flex-row md:items-end md:justify-between">
        <div>
          <h1 class="text-3xl font-semibold">Accounts</h1>
          <p class="mt-1 text-sm muted">Paylaşım için platform hesabını bağla (şimdilik mock connect).</p>
        </div>
        <button id="connectAllBtn" class="needs-login rounded-xl px-4 py-3 text-sm btn-primary font-medium">Hepsini bağla</button>
      </div>

      <div class="mt-6 grid grid-cols-1 gap-4 md:grid-cols-3" id="accountsGrid"></div>

      <div class="mt-6 card p-4">
        <div class="text-sm font-semibold">Gerçekte nasıl olacak?</div>
        <p class="mt-1 text-sm muted">
          Buradaki “Connect” ileride OAuth ile çalışacak. Token’lar client’ta değil backend’de saklanır.
        </p>
      </div>
    </section>

    <!-- LIBRARY -->
    <section class="page hidden" id="page-library">
      <div class="flex flex-col gap-2 md:flex-row md:items-end md:justify-between">
        <div>
          <h1 class="text-3xl font-semibold">Library</h1>
          <p class="mt-1 text-sm muted">Üretilen videolar (localStorage demo).</p>
        </div>
        <button id="clearJobsBtn" class="rounded-xl px-4 py-3 text-sm btn-ghost">Listeyi temizle</button>
      </div>

      <div class="mt-6 grid grid-cols-1 gap-4 md:grid-cols-3" id="jobGrid"></div>
      <div id="emptyJobs" class="mt-6 hidden card p-4">
        <div class="text-sm muted">Henüz video yok. Create’ten üret veya Workflows çalıştır.</div>
      </div>
    </section>

    <!-- PRICING -->
    <section class="page hidden" id="page-pricing">
      <h1 class="text-3xl font-semibold">Pricing</h1>
      <p class="mt-1 text-sm muted">Basit planlar (mock).</p>

      <div class="mt-6 grid grid-cols-1 gap-4 md:grid-cols-3">
        <div class="card p-5">
          <div class="text-sm muted">Free</div>
          <div class="mt-1 text-2xl font-semibold">Demo + Watermark</div>
          <ul class="mt-4 space-y-2 text-sm muted">
            <li>• 1 demo render</li>
            <li>• Sınırlı şablon</li>
          </ul>
          <button class="mt-5 w-full rounded-xl px-4 py-3 text-sm btn-ghost">Başla</button>
        </div>

        <div class="card p-5" style="box-shadow: var(--shadowBlue); border-color: rgba(47,107,255,.25);">
          <div class="text-sm muted">Creator</div>
          <div class="mt-1 text-2xl font-semibold">Sınırsız üretim</div>
          <ul class="mt-4 space-y-2 text-sm muted">
            <li>• Watermark yok</li>
            <li>• Daha çok şablon</li>
            <li>• Hızlı render kuyruğu</li>
          </ul>
          <button class="needs-login mt-5 w-full rounded-xl px-4 py-3 text-sm btn-primary font-medium">Satın al</button>
        </div>

        <div class="card p-5">
          <div class="text-sm muted">Pro Automation</div>
          <div class="mt-1 text-2xl font-semibold">Workflows</div>
          <ul class="mt-4 space-y-2 text-sm muted">
            <li>• Daily auto-create</li>
            <li>• Series builder</li>
            <li>• Hook optimizer</li>
          </ul>
          <button class="needs-login mt-5 w-full rounded-xl px-4 py-3 text-sm btn-ghost">İletişim / Kurulum</button>
        </div>
      </div>
    </section>

  </main>
</div>

<!-- Login Gate Modal -->
<div id="gateModal" class="fixed inset-0 z-[60] hidden items-center justify-center bg-black/40 p-4">
  <div class="w-full max-w-md card p-5">
    <div class="flex items-start justify-between">
      <div>
        <div class="text-lg font-semibold">Giriş gerekli</div>
        <div class="mt-1 text-sm muted">Bu işlemi yapmak için login olmalısın.</div>
      </div>
      <button id="closeGate" class="rounded-xl px-3 py-2 text-sm btn-ghost">Kapat</button>
    </div>

    <div class="mt-4 space-y-2">
      <a id="goLoginBtn" href="/login" class="block w-full rounded-xl px-4 py-3 text-center text-sm btn-primary font-medium">
        Login’e git
      </a>

      <button id="demoRenderBtn" class="hidden w-full rounded-xl px-4 py-3 text-sm btn-ghost">
        1 demo render yap (filigranlı)
      </button>

      <button id="continueGuest" class="w-full rounded-xl px-4 py-3 text-sm btn-ghost">
        Guest olarak devam et
      </button>
    </div>

    <p id="demoNote" class="mt-4 text-xs muted hidden">Demo render yalnızca 1 kez (guest).</p>
  </div>
</div>

<!-- Connect Modal -->
<div id="connectModal" class="fixed inset-0 z-[70] hidden items-center justify-center bg-black/40 p-4">
  <div class="w-full max-w-md card p-5">
    <div class="flex items-start justify-between">
      <div>
        <div class="text-lg font-semibold">Platform hesabını bağla</div>
        <div id="connectModalDesc" class="mt-1 text-sm muted">—</div>
      </div>
      <button id="closeConnectModal" class="rounded-xl px-3 py-2 text-sm btn-ghost">Kapat</button>
    </div>

    <div class="mt-4 card-soft p-4">
      <div class="text-sm font-semibold">İzinler (demo)</div>
      <ul class="mt-2 text-sm muted space-y-1">
        <li>• Video upload / publish</li>
        <li>• Basic profile</li>
        <li>• (Opsiyonel) analytics read</li>
      </ul>
    </div>

    <div class="mt-4 space-y-2">
      <button id="connectNowBtn" class="w-full rounded-xl px-4 py-3 text-sm btn-primary font-medium">
        Connect (Mock)
      </button>
      <button id="goAccountsBtn" class="w-full rounded-xl px-4 py-3 text-sm btn-ghost">
        Accounts sayfasına git
      </button>
    </div>

    <p class="mt-4 text-xs muted">
      Not: Bu prototipte “connect” localStorage’a kaydedilir. OAuth entegrasyonu backend aşamasında.
    </p>
  </div>
</div>

<script>
  // =========================
  // Helpers
  // =========================
  const $ = (id) => document.getElementById(id);

  function getUser(){ try { return JSON.parse(localStorage.getItem("demoUser")); } catch { return null; } }
  function isLoggedIn(){ return !!getUser(); }

  function getJobs(){ try { return JSON.parse(localStorage.getItem("videoJobs")) || []; } catch { return []; } }
  function setJobs(j){ localStorage.setItem("videoJobs", JSON.stringify(j)); }
  function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }

  function escapeHtml(s){
    return (s ?? "").toString().replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }

  // =========================
  // Sidebar (mobile)
  // =========================
  const sidebar = $("sidebar"), overlay = $("overlay");
  $("openSidebar")?.addEventListener("click", () => { sidebar.classList.remove("-translate-x-full"); overlay.classList.remove("hidden"); });
  $("closeSidebar")?.addEventListener("click", closeMenuFn);
  overlay?.addEventListener("click", closeMenuFn);
  function closeMenuFn(){ sidebar.classList.add("-translate-x-full"); overlay.classList.add("hidden"); }

  // =========================
  // Navigation
  // =========================
  const navButtons = document.querySelectorAll(".nav-btn");
  const pages = document.querySelectorAll(".page");

  function showPage(name){
    pages.forEach(p => p.classList.add("hidden"));
    $("page-"+name)?.classList.remove("hidden");

    navButtons.forEach(b => b.classList.remove("ring-2"));
    navButtons.forEach(b => { if (b.dataset.page === name) b.classList.add("ring-2"); });
    navButtons.forEach(b => { if (b.dataset.page === name) b.style.boxShadow = "inset 0 0 0 1px rgba(47,107,255,.35)"; else b.style.boxShadow=""; });

    closeMenuFn();
    localStorage.setItem("lastPage", name);
    window.location.hash = "#"+name;

    if (name === "library") renderLibrary();
    if (name === "accounts") renderAccountsPage();
    if (name === "create") flowAutostartIfAny();
  }

  navButtons.forEach(btn => btn.addEventListener("click", () => showPage(btn.dataset.page)));

  // =========================
  // Header personalization
  // =========================
  const guestBanner = $("guestBanner"), userBanner = $("userBanner");
  const creditsBadge = $("creditsBadge"), loginTopBtn = $("loginTopBtn"), logoutTopBtn = $("logoutTopBtn"), avatar = $("avatar");
  const userName = $("userName"), userPlan = $("userPlan"), guestDemoHint = $("guestDemoHint");

  function refreshHeader(){
    const u = getUser();
    if (!u){
      guestBanner.classList.remove("hidden");
      userBanner.classList.add("hidden");
      creditsBadge.classList.add("hidden");
      logoutTopBtn.classList.add("hidden");
      avatar.classList.add("hidden");
      loginTopBtn.classList.remove("hidden");

      const used = localStorage.getItem("guestDemoUsed") === "true";
      guestDemoHint.textContent = used ? "Demo render hakkını kullandın. Üretmek için login ol." : "Bonus: 1 demo render (filigranlı).";
      return;
    }
    guestBanner.classList.add("hidden");
    userBanner.classList.remove("hidden");
    userName.textContent = u.name || "User";
    userPlan.textContent = "Plan: " + (u.plan || "Free");
    creditsBadge.textContent = "Credits: " + (u.credits ?? 0);
    creditsBadge.classList.remove("hidden");
    loginTopBtn.classList.add("hidden");
    logoutTopBtn.classList.remove("hidden");
    avatar.classList.remove("hidden");
    avatar.textContent = (u.name || "U").slice(0,1).toUpperCase();
  }
  refreshHeader();

  // =========================
  // Login Gate Modal
  // =========================
  const gateModal = $("gateModal");
  const demoRenderBtn = $("demoRenderBtn");
  const demoNote = $("demoNote");
  let pendingAction = null;

  function openGate(action){
    pendingAction = action || null;
    const current = (window.location.hash || "#today").replace("#","");
    localStorage.setItem("afterLoginPage", current);

    const canDemo = (!isLoggedIn()) && (localStorage.getItem("guestDemoUsed") !== "true");
    demoRenderBtn.classList.toggle("hidden", !canDemo);
    demoNote.classList.toggle("hidden", !canDemo);

    gateModal.classList.remove("hidden");
    gateModal.classList.add("flex");
  }
  function closeGate(){ gateModal.classList.add("hidden"); gateModal.classList.remove("flex"); }
  $("closeGate").addEventListener("click", closeGate);
  $("continueGuest").addEventListener("click", closeGate);
  $("goLoginBtn").addEventListener("click", () => {
    const current = (window.location.hash || "#today").replace("#","");
    localStorage.setItem("afterLoginPage", current);
  });

  document.querySelectorAll(".needs-login").forEach(el => {
    el.addEventListener("click", (e) => {
      if (!isLoggedIn()){ e.preventDefault(); openGate("generic"); }
    });
  });

  // =========================
  // Connected Accounts (mock)
  // =========================
  const PLATFORMS = [
    { key:"tiktok", name:"TikTok", uiName:"TikTok", desc:"Viral, hızlı kısa içerikler" },
    { key:"reels", name:"Instagram Reels", uiName:"Instagram Reels", desc:"Keşfet odaklı, brand kit güçlü" },
    { key:"shorts", name:"YouTube Shorts", uiName:"YouTube Shorts", desc:"Seri içerik, retention odaklı" }
  ];

  function getConnectedAccounts(){
    try {
      return JSON.parse(localStorage.getItem("connectedAccounts")) || { tiktok:false, reels:false, shorts:false };
    } catch {
      return { tiktok:false, reels:false, shorts:false };
    }
  }
  function setConnectedAccount(key, val){
    const acc = getConnectedAccounts();
    acc[key] = !!val;
    localStorage.setItem("connectedAccounts", JSON.stringify(acc));
  }
  function isConnected(key){ return !!getConnectedAccounts()[key]; }

  // =========================
  // Connect Modal
  // =========================
  const connectModal = $("connectModal");
  const connectModalDesc = $("connectModalDesc");
  let pendingPlatformToConnect = null;

  function openConnectModal(platformKey){
    pendingPlatformToConnect = platformKey;
    const p = PLATFORMS.find(x => x.key === platformKey);
    connectModalDesc.textContent = p ? `${p.uiName} hesabını bağlayarak uygulamadan paylaşım yapabilirsin.` : "Hesabını bağla";
    connectModal.classList.remove("hidden");
    connectModal.classList.add("flex");
  }
  function closeConnectModalFn(){
    connectModal.classList.add("hidden");
    connectModal.classList.remove("flex");
    pendingPlatformToConnect = null;
  }

  $("closeConnectModal").addEventListener("click", closeConnectModalFn);
  $("goAccountsBtn").addEventListener("click", () => { closeConnectModalFn(); showPage("accounts"); });

  // Flow platform adımı connect beklerse:
  let deferredPlatformAdvance = false;

  $("connectNowBtn").addEventListener("click", () => {
    if (!pendingPlatformToConnect) return;
    setConnectedAccount(pendingPlatformToConnect, true);
    closeConnectModalFn();
    renderAccountsPage();

    // Eğer flow, platform seçimini connect yüzünden bekletiyorsa devam etsin
    if (deferredPlatformAdvance) {
      deferredPlatformAdvance = false;
      addAi(`Bağlandı ✅ Devam edelim.`);
      flowIndex++;
      updateFinalPrompt();
      nextQuestion();
    } else {
      if (typeof addAi === "function") addAi(`Bağlandı ✅`);
    }
  });

  // Connect All
  $("connectAllBtn").addEventListener("click", (e) => {
    if (!isLoggedIn()){ e.preventDefault(); openGate("connectAll"); return; }
    PLATFORMS.forEach(p => setConnectedAccount(p.key, true));
    renderAccountsPage();
  });

  // =========================
  // Accounts Page renderer
  // =========================
  function renderAccountsPage(){
    const grid = $("accountsGrid");
    if (!grid) return;
    const acc = getConnectedAccounts();
    grid.innerHTML = "";

    PLATFORMS.forEach(p => {
      const connected = !!acc[p.key];

      const card = document.createElement("div");
      card.className = "card p-4";

      card.innerHTML = `
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="font-semibold">${escapeHtml(p.uiName)}</div>
            <div class="mt-1 text-sm muted">${escapeHtml(p.desc)}</div>
          </div>
          <span class="text-xs rounded-full px-2 py-1"
                style="background:${connected ? 'rgba(16,185,129,.12)' : '#F1F4FB'}; border:1px solid ${connected ? 'rgba(16,185,129,.18)' : 'var(--border)'}; color:${connected ? '#065F46' : 'var(--muted)'};">
            ${connected ? "CONNECTED" : "NOT CONNECTED"}
          </span>
        </div>

        <div class="mt-4 grid grid-cols-2 gap-2">
          <button class="${connected ? "disconnectBtn btn-ghost" : "connectBtn btn-primary"} rounded-xl px-3 py-3 text-sm ${connected ? "" : "font-medium"}"
                  data-platform="${p.key}">
            ${connected ? "Disconnect" : "Connect"}
          </button>
          <button class="needs-login rounded-xl px-3 py-3 text-sm btn-ghost">Test publish</button>
        </div>
      `;

      grid.appendChild(card);
    });

    grid.querySelectorAll(".connectBtn").forEach(btn => {
      btn.addEventListener("click", (e) => {
        const key = btn.dataset.platform;
        if (!isLoggedIn()){ e.preventDefault(); openGate("connect"); return; }
        openConnectModal(key);
      });
    });

    grid.querySelectorAll(".disconnectBtn").forEach(btn => {
      btn.addEventListener("click", () => {
        const key = btn.dataset.platform;
        setConnectedAccount(key, false);
        renderAccountsPage();
      });
    });
  }

  // =========================
  // Today: trends
  // =========================
  const trends = [
    { title:"AI tarafında yeni model duyuruları", category:"Tech" },
    { title:"Telefon güncellemeleri: en büyük değişiklikler", category:"Tech" },
    { title:"Viral challenge: neden bu kadar tuttu?", category:"Entertainment" },
    { title:"Finans: teknoloji hisseleri & kripto gündemi", category:"Finance" },
    { title:"Oyun dünyasında büyük lansman: kısa özet", category:"Gaming" },
    { title:"Gündem: haftanın konuşulan konusu", category:"Agenda" },
  ];

  const trendCards = $("trendCards");
  let selectedTrend = null, selectedFormat = null;

  function formatLabel(k){
    if (k==="summary") return "Özet";
    if (k==="top3") return "Top 3";
    if (k==="story") return "Story";
    return k;
  }

  function setSelection(trendTitle, fmtKey){
    selectedTrend = trendTitle;
    selectedFormat = fmtKey;
    $("selectedTrend").textContent = trendTitle || "—";
    $("selectedFormat").textContent = "Format: " + (fmtKey ? formatLabel(fmtKey) : "—");
  }

  function renderTrendCards(){
    trendCards.innerHTML = "";
    trends.forEach(t => {
      const card = document.createElement("div");
      card.className = "card-soft p-4";
      card.innerHTML = `
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-xs muted">${escapeHtml(t.category)}</div>
            <div class="mt-1 font-semibold">${escapeHtml(t.title)}</div>
          </div>
          <span class="text-xs rounded-full px-2 py-1" style="background: rgba(47,107,255,.10); border:1px solid rgba(47,107,255,.18);">
            Trend
          </span>
        </div>

        <div class="mt-3 grid grid-cols-3 gap-2">
          <button class="fmt chip rounded-xl px-3 py-2 text-sm" data-fmt="summary">Özet</button>
          <button class="fmt chip rounded-xl px-3 py-2 text-sm" data-fmt="top3">Top 3</button>
          <button class="fmt chip rounded-xl px-3 py-2 text-sm" data-fmt="story">Story</button>
        </div>
      `;

      card.querySelectorAll(".fmt").forEach(btn => {
        btn.addEventListener("click", () => setSelection(t.title, btn.dataset.fmt));
      });

      trendCards.appendChild(card);
    });
  }
  renderTrendCards();

  $("useTrendBtn").addEventListener("click", () => {
    if (!selectedTrend) return;
    sessionStorage.setItem("prefillFlow", JSON.stringify({
      source: "trend",
      topic: selectedTrend,
      contentType: selectedFormat || "summary"
    }));
    showPage("create");
  });

  // =========================
  // Prompt Flow (chat-like)
  // =========================
  const flowChat = $("flowChat");
  const finalPromptBox = $("finalPromptBox");

  const flowState = {
    source: null,
    topic: null,
    freePrompt: null,
    contentType: null,
    duration: null,
    platform: null,     // UI label
    tone: null,
    voice: null,
    captions: null
  };

  const FLOW = [
    {
      key: "source",
      ask: "Başlayalım. Ne üzerinden üretelim?",
      options: [
        { label:"Trend seçtim (Today’den geldim)", value:"trend" },
        { label:"Prompt yazacağım", value:"prompt" },
        { label:"Workflow preset kullan", value:"workflow" }
      ],
      onPick: (v) => {
        if (v==="workflow"){
          addAi("Seni Workflows sayfasına yönlendiriyorum. Preset seç → Use.");
          showPage("workflows");
          return "STOP";
        }
      }
    },
    {
      key:"topic",
      ask:"Konu ne olsun?",
      options: [
        { label:"Teknoloji", value:"Teknoloji" },
        { label:"Gündem", value:"Gündem" },
        { label:"Eğlence", value:"Eğlence" },
        { label:"Finans", value:"Finans" },
        { label:"Oyun", value:"Oyun" },
        { label:"Ben yazacağım", value:"__free__" }
      ],
      onPick: (v) => {
        if (v==="__free__"){
          addAi("Aşağıdaki kutuya serbest prompt yazıp ‘Prompt’u uygula’ de. Sonra kaldığımız yerden devam edeceğiz.");
          return "STOP";
        }
      }
    },
    {
      key:"contentType",
      ask:"Hangi format?",
      options: [
        { label:"Özet", value:"summary" },
        { label:"Top 3", value:"top3" },
        { label:"Story", value:"story" },
        { label:"Myth-bust", value:"myth" }
      ]
    },
    {
      key:"duration",
      ask:"Süre?",
      options: [
        { label:"15–25 sn (çok hızlı)", value:"15–25 sn" },
        { label:"25–35 sn (ideal)", value:"25–35 sn" },
        { label:"35–45 sn (daha detay)", value:"35–45 sn" },
        { label:"45–60 sn (max short)", value:"45–60 sn" }
      ]
    },
    {
      key:"platform",
      ask:"Hangi platform için optimize edelim? (Paylaşım için hesabı bağlı olmalı)",
      options: [
        { label:"TikTok", value:"TikTok" },
        { label:"Instagram Reels", value:"Instagram Reels" },
        { label:"YouTube Shorts", value:"YouTube Shorts" }
      ]
    },
    {
      key:"tone",
      ask:"Ton?",
      options: [
        { label:"Enerjik", value:"Enerjik" },
        { label:"Ciddi", value:"Ciddi" },
        { label:"Komik", value:"Komik" }
      ]
    },
    {
      key:"voice",
      ask:"Ses?",
      options: [
        { label:"Erkek (TR)", value:"Erkek (TR)" },
        { label:"Kadın (TR)", value:"Kadın (TR)" },
        { label:"Ses yok (sadece altyazı)", value:"No Voice" }
      ]
    },
    {
      key:"captions",
      ask:"Altyazı stili?",
      options: [
        { label:"Auto + Highlight", value:"Auto + Highlight" },
        { label:"Sade", value:"Sade" },
        { label:"Kapalı", value:"Kapalı" }
      ]
    }
  ];

  let flowIndex = 0;

  function addAi(text, opts){
    const wrap = document.createElement("div");
    wrap.className = "flex items-start gap-3";
    wrap.innerHTML = `
      <div class="h-8 w-8 rounded-xl flex items-center justify-center text-xs font-semibold"
           style="background: rgba(47,107,255,.12); border:1px solid rgba(47,107,255,.18); color: var(--text);">AI</div>
      <div class="bubble-ai rounded-2xl p-4 max-w-[640px]">
        <div class="text-sm">${escapeHtml(text)}</div>
        ${opts ? renderOptions(opts) : ""}
      </div>
    `;
    flowChat.appendChild(wrap);
    scrollFlowBottom();
  }

  function addUser(text){
    const wrap = document.createElement("div");
    wrap.className = "flex justify-end";
    wrap.innerHTML = `
      <div class="bubble-user rounded-2xl p-3 max-w-[640px]">
        <div class="text-sm">${escapeHtml(text)}</div>
      </div>
    `;
    flowChat.appendChild(wrap);
    scrollFlowBottom();
  }

  function renderOptions(opts){
    const buttons = opts.map(o => `
      <button class="flowOpt chip rounded-xl px-3 py-2 text-sm mt-3 mr-2"
              data-value="${escapeHtml(o.value)}">${escapeHtml(o.label)}</button>
    `).join("");
    return `<div class="mt-1">${buttons}</div>`;
  }

  function scrollFlowBottom(){
    flowChat.scrollTop = flowChat.scrollHeight;
  }

  function resetFlow(){
    flowChat.innerHTML = "";
    flowIndex = 0;
    for (const k of Object.keys(flowState)) flowState[k] = null;
    $("freePrompt").value = "";

    addAi("Merhaba. Birkaç tıkla videonu netleştirelim.");
    nextQuestion();
    updateFinalPrompt();
    $("watermarkBadge").classList.add("hidden");
  }

  function nextQuestion(){
    while (flowIndex < FLOW.length) {
      const step = FLOW[flowIndex];

      // If trend already prefilled, skip topic question.
      if (step.key === "topic" && flowState.source === "trend" && flowState.topic){
        flowIndex++;
        continue;
      }

      // If prompt provided, skip topic question
      if (step.key === "topic" && flowState.source === "prompt" && flowState.freePrompt){
        flowIndex++;
        continue;
      }

      addAi(step.ask, step.options);
      bindOptionClicks(step);
      break;
    }

    // completed
    if (flowIndex >= FLOW.length){
      addAi("Hazır ✅ İstersen ‘Üret’ diyebilirsin.");
    }
  }

  function bindOptionClicks(step){
    const all = Array.from(flowChat.querySelectorAll(".flowOpt"));
    const lastGroup = Array.from(flowChat.lastElementChild.querySelectorAll(".flowOpt"));
    all.forEach(b => {
      if (!lastGroup.includes(b)) {
        b.disabled = true;
        b.classList.add("opacity-50","cursor-not-allowed");
      }
    });

    lastGroup.forEach(btn => {
      btn.addEventListener("click", () => {
        const value = btn.dataset.value;
        flowState[step.key] = value;

        addUser(`${humanKey(step.key)}: ${btn.textContent}`);

        // step hook
        if (typeof step.onPick === "function"){
          const r = step.onPick(value);
          updateFinalPrompt();
          if (r === "STOP") return;
        }

        // Special: platform selection requires connect
        if (step.key === "platform") {
          const map = { "TikTok":"tiktok", "Instagram Reels":"reels", "YouTube Shorts":"shorts" };
          const key = map[value];

          if (key && !isConnected(key)) {
            // If not logged in, gate first (connect is an action)
            if (!isLoggedIn()){
              addAi(`${value} için paylaşım yapabilmek adına hesabı bağlamak gerekiyor. Login olmadan bağlayamazsın.`);
              openGate("connect");
              return;
            }

            addAi(`${value} hesabın bağlı değil. Şimdi bağlayalım.`);
            deferredPlatformAdvance = true;
            openConnectModal(key);
            // Do NOT advance flowIndex yet; connect modal completion will advance.
            return;
          }
        }

        flowIndex++;
        updateFinalPrompt();

        if (step.key === "source" && value === "prompt"){
          addAi("İstersen serbest prompt yazabilirsin (alttan). Yazmazsan ben topic soracağım.");
        }

        nextQuestion();
      }, { once:true });
    });
  }

  function humanKey(k){
    if (k==="source") return "Kaynak";
    if (k==="topic") return "Konu";
    if (k==="contentType") return "Format";
    if (k==="duration") return "Süre";
    if (k==="platform") return "Platform";
    if (k==="tone") return "Ton";
    if (k==="voice") return "Ses";
    if (k==="captions") return "Altyazı";
    return k;
  }

  function updateFinalPrompt(){
    const contentType = flowState.contentType || "summary";
    const typeText =
            contentType === "top3" ? "Top 3 formatında" :
                    contentType === "story" ? "Story mode şeklinde" :
                            contentType === "myth" ? "Myth-bust formatında" :
                                    "Özet formatında";

    const parts = [];
    if (flowState.freePrompt) parts.push(`Kullanıcı promptu: ${flowState.freePrompt}`);
    else if (flowState.topic) parts.push(`Konu: ${flowState.topic}`);
    else parts.push(`Konu: (seçilmedi)`);

    parts.push(`İçerik: ${typeText}`);
    if (flowState.duration) parts.push(`Süre: ${flowState.duration}`);
    if (flowState.platform) parts.push(`Platform: ${flowState.platform}`);
    if (flowState.tone) parts.push(`Ton: ${flowState.tone}`);
    if (flowState.voice) parts.push(`Ses: ${flowState.voice}`);
    if (flowState.captions) parts.push(`Altyazı: ${flowState.captions}`);

    const final =
            `Bir short video üret.

${parts.join("\n")}

Kurallar:
- İlk 1-2 saniye güçlü hook
- Kısa cümleler
- Platform oranına uygun kadraj
- Sonda izleyiciye soru (CTA)`;

    finalPromptBox.textContent = final;
  }

  // Free prompt apply
  $("applyFreePromptBtn").addEventListener("click", () => {
    const p = $("freePrompt").value.trim();
    if (!p) return;

    flowState.source = flowState.source || "prompt";
    flowState.freePrompt = p;

    addUser("Prompt: " + p);
    updateFinalPrompt();
    nextQuestion();
  });

  $("resumeFlowBtn").addEventListener("click", () => nextQuestion());
  $("resetFlowBtn").addEventListener("click", () => resetFlow());

  $("flowWhyBtn").addEventListener("click", () => $("flowWhyTip").classList.toggle("hidden"));

  function flowAutostartIfAny(){
    const raw = sessionStorage.getItem("prefillFlow");
    if (!raw) { if (!flowChat.hasChildNodes()) resetFlow(); return; }

    sessionStorage.removeItem("prefillFlow");
    resetFlow();

    try {
      const pf = JSON.parse(raw);
      flowState.source = pf.source || "trend";
      flowState.topic = pf.topic || null;
      flowState.contentType = pf.contentType || null;

      addUser(`Kaynak: ${flowState.source === "trend" ? "Trend" : flowState.source}`);
      if (flowState.topic) addUser(`Konu: ${flowState.topic}`);
      if (flowState.contentType) addUser(`Format: ${formatLabel(flowState.contentType)}`);

      updateFinalPrompt();

      // advance index beyond source question
      flowIndex = 0;
      while (flowIndex < FLOW.length && FLOW[flowIndex].key !== "source") flowIndex++;
      if (flowIndex < FLOW.length && FLOW[flowIndex].key === "source") flowIndex++;

      nextQuestion();
    } catch {
      resetFlow();
    }
  }

  // boot flow once
  resetFlow();

  // =========================
  // Workflows
  // =========================
  const workflows = [
    {
      id:"wf_daily_tech",
      title:"Daily Tech Digest",
      desc:"Trend → Özet → 25–35sn → Reels",
      prefill:{ source:"trend", contentType:"summary", duration:"25–35 sn", platform:"Instagram Reels", tone:"Enerjik", voice:"Erkek (TR)", captions:"Auto + Highlight" }
    },
    {
      id:"wf_top3_series",
      title:"Top 3 Series",
      desc:"Topic → Top 3 → TikTok",
      prefill:{ source:"prompt", contentType:"top3", duration:"25–35 sn", platform:"TikTok", tone:"Komik", voice:"Kadın (TR)", captions:"Auto + Highlight" }
    },
    {
      id:"wf_story_mode",
      title:"Story Mode",
      desc:"Story → Shorts → 35–45sn",
      prefill:{ source:"prompt", contentType:"story", duration:"35–45 sn", platform:"YouTube Shorts", tone:"Ciddi", voice:"Erkek (TR)", captions:"Sade" }
    }
  ];

  function renderWorkflowCards(){
    const wrap = $("workflowCards");
    wrap.innerHTML = "";

    workflows.forEach(w => {
      const card = document.createElement("div");
      card.className = "card-soft p-4";
      card.innerHTML = `
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="font-semibold">${escapeHtml(w.title)}</div>
            <div class="mt-1 text-sm muted">${escapeHtml(w.desc)}</div>
          </div>
          <span class="text-xs rounded-full px-2 py-1" style="background: rgba(47,107,255,.10); border:1px solid rgba(47,107,255,.18);">
            Preset
          </span>
        </div>
        <div class="mt-4 grid grid-cols-2 gap-2">
          <button class="wfUse rounded-xl px-3 py-3 text-sm btn-primary font-medium">Use</button>
          <button class="wfRun rounded-xl px-3 py-3 text-sm btn-ghost">Run</button>
        </div>
      `;

      card.querySelector(".wfUse").addEventListener("click", () => {
        sessionStorage.setItem("prefillFlow", JSON.stringify({
          source: w.prefill.source,
          topic: null,
          contentType: w.prefill.contentType
        }));

        showPage("create");

        // apply other params instantly
        flowState.duration = w.prefill.duration;
        flowState.platform = w.prefill.platform;
        flowState.tone = w.prefill.tone;
        flowState.voice = w.prefill.voice;
        flowState.captions = w.prefill.captions;
        updateFinalPrompt();

        addAi("Workflow preset uygulandı. Akıştan konu/prompt seçip devam edebilirsin.");
      });

      card.querySelector(".wfRun").addEventListener("click", (e) => {
        if (!isLoggedIn()){ e.preventDefault(); openGate("runWorkflow"); return; }
        const jobs = getJobs();
        for (let i=1;i<=3;i++){
          jobs.unshift({
            id: uid(),
            title: `${w.title} #${i}`,
            platform: w.prefill.platform || "—",
            status: "READY",
            watermark: false,
            createdAt: Date.now() - i * 1000
          });
        }
        setJobs(jobs);
        showPage("library");
      });

      wrap.appendChild(card);
    });
  }
  renderWorkflowCards();

  // =========================
  // Generate (logged-in OR 1 guest demo)
  // =========================
  const renderState = $("renderState"), renderPct = $("renderPct"), renderBar = $("renderBar"), renderNote = $("renderNote");
  const watermarkBadge = $("watermarkBadge");

  function addJobToLibrary({ title, platform, watermark }){
    const jobs = getJobs();
    jobs.unshift({
      id: uid(),
      title,
      platform,
      status: "READY",
      watermark: !!watermark,
      createdAt: Date.now()
    });
    setJobs(jobs);
  }

  function runFakeRender({ watermark }){
    watermarkBadge.classList.toggle("hidden", !watermark);

    let pct = 0;
    renderState.textContent = "RENDERING";
    renderNote.textContent = watermark ? "Demo render: filigranlı çıktı." : "Render başladı (demo).";

    const timer = setInterval(() => {
      pct += 8;
      if (pct >= 100){
        pct = 100;
        clearInterval(timer);
        renderState.textContent = "READY";
        renderNote.textContent = watermark ? "Demo video hazır (filigranlı). Library’de gör." : "Video hazır. Library’de gör.";

        const baseTitle = flowState.topic || flowState.freePrompt || "Untitled";
        addJobToLibrary({
          title: baseTitle.toString().slice(0, 32) + (baseTitle.length > 32 ? "…" : ""),
          platform: flowState.platform || "—",
          watermark
        });
      }
      renderPct.textContent = pct + "%";
      renderBar.style.width = pct + "%";
    }, 220);
  }

  $("generateBtn").addEventListener("click", (e) => {
    if (isLoggedIn()){ runFakeRender({ watermark:false }); return; }

    const used = localStorage.getItem("guestDemoUsed") === "true";
    if (!used){
      localStorage.setItem("guestDemoUsed", "true");
      refreshHeader();
      runFakeRender({ watermark:true });
      return;
    }

    e.preventDefault();
    openGate("generate");
  });

  demoRenderBtn.addEventListener("click", () => {
    const used = localStorage.getItem("guestDemoUsed") === "true";
    if (used) return;

    localStorage.setItem("guestDemoUsed", "true");
    closeGate();
    refreshHeader();
    showPage("create");
    runFakeRender({ watermark:true });
  });

  // =========================
  // Library
  // =========================
  const jobGrid = $("jobGrid");
  const emptyJobs = $("emptyJobs");

  $("clearJobsBtn").addEventListener("click", () => {
    setJobs([]);
    renderLibrary();
  });

  function renderLibrary(){
    const jobs = getJobs();
    jobGrid.innerHTML = "";
    emptyJobs.classList.toggle("hidden", jobs.length !== 0);

    jobs.forEach(j => {
      const card = document.createElement("div");
      card.className = "card p-4";

      card.innerHTML = `
        <div class="aspect-[9/16] rounded-2xl relative overflow-hidden"
             style="background:#F1F4FB; border:1px solid var(--border);">
          <div class="absolute inset-0"
               style="background: radial-gradient(circle at 30% 20%, rgba(47,107,255,.16), transparent 55%),
                              radial-gradient(circle at 80% 60%, rgba(47,107,255,.08), transparent 55%);"></div>
          ${j.watermark ? `<div class="absolute right-3 top-3 rounded-full px-3 py-1 text-xs"
                             style="background: rgba(0,0,0,.05); border: 1px dashed rgba(0,0,0,.20);">WATERMARK</div>` : ``}
        </div>

        <div class="mt-3 flex items-center justify-between gap-2">
          <div class="font-medium truncate">${escapeHtml(j.title)}</div>
          <span class="text-xs rounded-full px-2 py-1"
                style="background:#F1F4FB; border:1px solid var(--border); color: var(--muted);">
            ${escapeHtml(j.status)}
          </span>
        </div>

        <div class="mt-1 text-sm muted">${escapeHtml(j.platform)} • ${new Date(j.createdAt).toLocaleString()}</div>

        <div class="mt-3 grid grid-cols-2 gap-2">
          <button class="needs-login rounded-xl px-3 py-3 text-sm btn-ghost">İndir</button>
          <button class="needs-login rounded-xl px-3 py-3 text-sm btn-primary font-medium">Paylaş</button>
        </div>
      `;
      jobGrid.appendChild(card);
    });
  }

  // =========================
  // Initial load
  // =========================
  const initial = (window.location.hash || ("#" + (localStorage.getItem("lastPage") || "today"))).replace("#","");
  showPage(initial);

  // =========================
  // Minor: close gate/menus on esc
  // =========================
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      closeGate();
      closeConnectModalFn();
      closeMenuFn();
    }
  });
</script>

</body>
</html>
